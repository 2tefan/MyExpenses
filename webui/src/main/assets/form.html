<!doctype html>
<!--suppress HtmlUnknownAttribute -->
<html style="color-scheme: light dark;">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>${i18n_title}</title>

    <link href="styles.css" rel="stylesheet">

    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0"/>

    <link rel="icon" href="/favicon.ico">

    <script defer src="https://unpkg.com/alpinejs@3.10.2/dist/cdn.min.js"></script>

</head>

<body x-data="modelData()"
      x-init="account = data.accounts[0].id;
      $watch('amount', value => { if (value < 0) amount = -value } );
      ${categoryWatchers}" class="bg-white dark:bg-neutral-900"
>
<div class="flex justify-center">
    <div class="max-w-screen-sm w-full rounded shadow-lg p-8 m-4 text-slate-500 dark:text-white dark:border dark:border-white">
        <form>
            <div class="flex flex-col mb-4">
                <label class="mb-2 uppercase font-bold text-lg"
                       for="account">${i18n_account}</label>
                <div class="flex flex-row">
                    <select class="grow mr-2" name="account" id="account" x-model="account">
                        <template x-for="item in data.accounts" :key="item.id">
                            <option :value="item.id" x-text="item.label"></option>
                        </template>
                    </select>
                    <button type="button" @click="loadTransactions(account)
                    .then(response => {
                        resultCode = response.status;
                        resultText = resultCode == 200 ? '' : 'ERROR';
                        response.json().then(data => { transactions = data } );
                        } );">
                        <span class="material-symbols-outlined ml-2">folder_open</span>
                    </button>
                </div>
            </div>
            <div class="relative overflow-y-auto max-h-48"
                 x-data="{menuOpen:false, activeTransaction:null}"
                 @click.outside="menuOpen = false">
                <table class="w-full border border-spacing-x-px">
                    <template x-for="item in transactions" :key="item.id">

                        <tr class="odd:bg-white even:bg-slate-100 dark:odd:bg-neutral-900 dark:even:bg-neutral-800 cursor-pointer p-1 hover:bg-slate-200 dark:hover:bg-neutral-700"
                            @click="if (!menuOpen) { positionPopup($event, $refs.menu); activeTransaction = item }; menuOpen = !menuOpen">
                            <td class="p-1" x-text="item.dateFormatted"></td>
                            <td class="w-full p-1">
                                <div x-html="item.displayHtml"></div>
                            </td>
                            <td class="text-end p-1"
                                :class="item.amount > 0 ? 'text-green-500' : 'text-red-500'">
                                <span x-text="item.amountFormatted"></span>
                            </td>
                        </tr>
                    </template>
                </table>
                <div x-ref="menu"
                     class="fixed top-0 border border-solid border-neutral-500 rounded p-1 bg-white dark:bg-neutral-900"
                     x-show="menuOpen">
                    <a href="#" @click="menuOpen = false;
                    id = activeTransaction.id
                    signum = activeTransaction.amount > 0 ? true : false;
                    amount = activeTransaction.amount;
                    payee = activeTransaction.payee;
                    comment = activeTransaction.comment;
                    number = activeTransaction.number;
                    date = activeTransaction.date;
                    time = activeTransaction.time;
                    valueDate = activeTransaction.valueDate;
                    let newPath = pathFromTerminalNode(data.categories, activeTransaction.category)
                    let lastIndex = newPath.length - 1
                    for (let index = lastIndex; index >= 0; index--) {
                        categoryPath[lastIndex - index].id = newPath[index].id;
                        await $nextTick();
                    }
                    selectedTags = activeTransaction.tags;
                    method = activeTransaction.method
                    "><span class="material-symbols-outlined mr-1 align-middle">edit</span>${i18n_edit}</a>
                </div>
            </div>


            <div class="flex flex-col mb-4">
                <label class="mb-2 uppercase font-bold text-lg" for="amount">${i18n_amount}</label>
                <div>
                    <label class="switch mr-2">
                        <input type="checkbox" name="type" x-model="signum">
                        <span class="slider round"></span>
                    </label>
                    <input class="border py-2 px-3 align-middle mr-2" type="number"
                           name="amount" id="amount" step="0.01" min="0" required
                           x-model="amount">
                    <span x-text="accountCurrency(data, account)"></span>
                </div>
            </div>

            <div class="flex flex-col mb-4">
                <label class="mb-2 uppercase font-bold text-lg"
                       x-text="dateRowLabel(data, account)">${i18n_date}</label>
                <div class="flex flex-row">
                    <input class="grow border py-2 px-3 mr-2" type="date" name="date" id="date"
                           required x-model="date">
                    <input x-show="currentDateMode(data, account) == dateMode.dateTime"
                           class="grow border py-2 px-3 ml-2" type="time" name="time" id="time"
                           x-model="time"
                           required>
                    <input x-show="currentDateMode(data, account) == dateMode.bookingValue"
                           class="grow border py-2 px-3 mr-2" type="date" name="valueDate"
                           id="valueDate"
                           required
                           x-model="valueDate">
                </div>
            </div>

            <div class="flex flex-col mb-4">
                <label class="mb-2 uppercase font-bold text-lg"
                       for="payee">${i18n_payee}</label>
                <input class="border py-2 px-3" list="payees" name="payee"
                       id="payee"
                       x-model="payee">
                <datalist id="payees">
                    <template x-for="item in data.payees" :key="item.id">
                        <option x-text="item.name"></option>
                    </template>
                </datalist>
            </div>

            <div class="flex flex-col mb-4" x-show="data.categories.length > 0">
                <label class="mb-2 uppercase font-bold text-lg">${i18n_category}</label>
                <div class="grid grid-cols-${category_tree_depth} gap-2">
                    <template x-for="(category, level) in categoryPath">
                        <select class="h-8" :name="'category_' + level" :id="'category_' + level"
                                x-model="category.id">
                            <option value="0"></option>
                            <template
                                    x-for="item in categoriesByParent(data.categories, (level == 0) ? null : categoryPath[level-1].id)"
                                    :key="item.id">
                                <option :value="item.id" x-text="item.label"></option>
                            </template>
                        </select>
                    </template>
                </div>
            </div>

            <div class="flex flex-col mb-4" x-show="data.tags.length > 0">
                <label class="mb-2 uppercase font-bold text-lg" for="tags">${i18n_tags}</label>
                <select name="tags" id="tags" multiple x-model="selectedTags">
                    <template x-for="item in data.tags" :key="item.id">
                        <option :value="item.id" x-text="item.label"></option>
                    </template>
                </select>
            </div>

            <div class="flex flex-col mb-4"
                 x-show="methodsForTypes(data, account, signum).length > 0">
                <label class="mb-2 uppercase font-bold text-lg" for="tags">${i18n_method}</label>
                <div class="grid grid-cols-2 gap-2">
                    <select class="h-8" name="method" id="method" x-model="method">
                        <option value="0"></option>
                        <template x-for="item in methodsForTypes(data, account, signum)"
                                  :key="item.id">
                            <option :value="item.id" x-text="item.label"></option>
                        </template>
                    </select>
                    <input class="h-8 border py-2 px-3  align-middle"
                           x-show="method !=0 && data.methods.find(item => item.id == method).isNumbered"
                           placeholder="${i18n_number}"
                           name="number" id="number" x-model="number">
                </div>
            </div>

            <div class="flex flex-col mb-4">
                <label class="mb-2 uppercase font-bold text-lg" for="notes">${i18n_notes}</label>
                <textarea name="notes" id="notes" x-model="comment"></textarea>
            </div>

            <div class="relative">
                <button class="block bg-green-500 hover:bg-green-700 disabled:opacity-50 text-white uppercase text-lg mx-auto p-4 rounded"
                        type="button" :disabled="amount == ''" @click="submitForm({
                            id: id,
                            account: account,
                            amount: signum ? amount : -amount,
                            date: date,
                            time: (currentDateMode(data, account) == dateMode.dateTime) ? time : null,
                            valueDate: valueDate,
                            payee: payee,
                            category: terminalNodeFromPath(categoryPath),
                            tags: selectedTags,
                            comment: comment,
                            method: method,
                            number: number}).then(response => {
                        resultCode = response.status
    response.text().then(text => resultText = text)
    }).catch(errorHandler)">${i18n_submit}<br><span class="text-xs"
                                                    x-text="'(' + (id == 0 ? '${i18n_create_transaction}' : '${i18n_edit_transaction}') + ')'"></span>
                </button>
                <button class="absolute bottom-0 right-0" type="button" @click="if (confirm('${i18n_discard_changes}')) {
                    let now = new Date();
                    let dateFormatted = formatDate(now);
                    id = 0; amount = ''; date = dateFormatted; valueDate = dateFormatted; time = formatTime(now); payee = ''; comment = '';
                    if (categoryPath.length > ß) { categoryPath[0].id = 0; };
                    selectedTags = []; method = 0; number = ''; resultText = ''; resultCode = 0;
                 }
">Reset</button>
            </div>
        </form>
        <div x-text="resultText"
             :class="resultCode < 300 ? 'text-current' : 'text-red-500'"></div>
    </div>
</div>

<script>
const dateMode = {
  date: 1,
  dateTime: 2,
  bookingValue: 3
};

function currentDateMode(data, account) {
    var type = accountType(data, account)
    if (!(type == "CASH")) {
      if (${withValueDate}) {
        return dateMode.bookingValue;
      }
    }
    return ${withTime} ? dateMode.dateTime : dateMode.date;
}

function dateRowLabel(data, account) {
    switch(currentDateMode(data, account)) {
      case dateMode.date: return "${i18n_date}";
      case dateMode.dateTime: return "${i18n_date} / ${i18n_time}";
      case dateMode.bookingValue: return "${i18n_booking_date} / ${i18n_value_date}";
    }
}

var errorHandler = (error) => alert('Error: ' + error)

function categoriesByParent(array, parent) {
    return array.filter(item => item.parent == parent)
}

function methodsForTypes(data, account, signum) {
    return data.methods.filter(item => item.accountTypes.includes(accountType(data, account)) && (item.type == 0 || item.type == (signum ? 1 : -1)))
}

function accountType(data, account) {
    return data.accounts.find(item => item.id == account).type
}

function accountCurrency(data, account) {
    return data.accounts.find(item => item.id == account).currency
}

function terminalNodeFromPath(path) {
  return path.reduce((acc, curr) => curr.id == 0 ? acc : curr.id, null);
}

function pathFromTerminalNode(array, category) {
    let result = [];
    let node = category;
    while(true) {
        result.push( { id: node } );
        node = array.find(item => item.id == node).parent;
        if (node == undefined) break;
    }
    return result
}

function modelData() {
    let date = new Date();
    let dateFormatted = formatDate(date);
    return {
        id: 0,
        signum: false,
        amount: '',
        date: dateFormatted,
        valueDate: dateFormatted,
        time: formatTime(date),
        payee: '',
        account: 0,
        comment: '',
        categoryPath:  Array.from(Array(${category_tree_depth}), () => { return { id: 0 }; }),
        selectedTags: [],
        method: 0,
        number: '',
        resultText: '',
        resultCode: 0,
        data: ${data},
        transactions: []
    }
}

function formatPart(number) {
    return number.toString().padStart(2, '0')
}

function formatDate(date) {
  let month = formatPart(date.getMonth() + 1);
  let day = formatPart(date.getDate());
  let year = date.getFullYear();
  return [year, month, day].join('-');
}

function formatTime(date) {
  let hours = formatPart(date.getHours());
  let minutes = formatPart(date.getMinutes());
  return [hours, minutes].join(':');
}

function submitForm(data) {
    return fetch("/", {
        headers: {
            'Content-Type': 'application/json'
        },
        method: 'POST',
        body: JSON.stringify(data)
    });
}

function loadTransactions(account) {
    return fetch("/accounts/"+account, {
            headers: {
                'Content-Type': 'application/json'
            },
            method: 'GET'
        });
}

function positionPopup(event, menu) {
    menu.style.top = event.pageY + "px"
    menu.style.left = event.pageX + "px"
}


</script>

</body>
</html>