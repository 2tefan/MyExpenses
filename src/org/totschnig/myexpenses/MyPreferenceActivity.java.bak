package org.totschnig.myexpenses;

import java.io.FileInputStream;
import java.util.Hashtable;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;

import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;

import org.xmlpull.v1.XmlPullParser;

import android.preference.PreferenceActivity;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;
import android.widget.Toast;
import android.os.Bundle;
import android.os.Handler;
import android.os.Message;
import android.util.Log;
import android.util.Xml;
import android.app.Dialog;
import android.app.ProgressDialog;


public class MyPreferenceActivity extends PreferenceActivity {
	static final int PROGRESS_DIALOG = 0;
	int totalCategories = 0;
	static final String CATEGORIES_XML = "/sdcard/myexpenses/categories.xml";
    ProgressDialog progressDialog;
    ProgressThread progressThread;
    NodeList categories;
    NodeList sub_categories;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
    	Button importButton;
        super.onCreate(savedInstanceState);

        addPreferencesFromResource(R.layout.preferences);
        setContentView(R.layout.preference_screen);
        importButton = (Button) findViewById(R.id.import_cat);
        importButton.setOnClickListener(new OnClickListener() {
            public void onClick(View v) {
            	Log.i("DEBUG","Now in onclick");
            	Message msg = handler.obtainMessage();
                msg.arg1 = -1;
                handler.sendMessage(msg);
            	DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
            	try {
            		Log.i("DEBUG","Now starting parsing");
                    DocumentBuilder builder = factory.newDocumentBuilder();
                    Document dom = builder.parse(new FileInputStream(CATEGORIES_XML));
                    Element root = dom.getDocumentElement();
                    categories = root.getElementsByTagName("Category");
                    sub_categories = root.getElementsByTagName("Sub_category");
                    totalCategories = categories.getLength() + sub_categories.getLength();
                    Log.i("DEBUG","Now finished parsing and showing dialog");
                    showDialog(PROGRESS_DIALOG);
            	}  catch (Exception e) {
            		Log.e("MyExpenses",e.toString());
            		Toast.makeText(MyPreferenceActivity.this,getString(R.string.import_categories_failure), Toast.LENGTH_LONG).show();
    	        	//result = 0;
                }
            	 //new MyAsyncTask(MyPreferenceActivity.this).execute();
            	
          }
        }
     );
    }
    protected Dialog onCreateDialog(int id) {
    	Log.i("DEBUG","Now in create dialog");
        switch(id) {
        case PROGRESS_DIALOG:
            progressDialog = new ProgressDialog(MyPreferenceActivity.this);
            progressDialog.setProgressStyle(ProgressDialog.STYLE_HORIZONTAL);
            progressDialog.setMax(totalCategories);
            return progressDialog;
        default:
            return null;
        }
    }
    @Override
    protected void onPrepareDialog(int id, Dialog dialog) {
    	Log.i("DEBUG","Now in prepare dialog");
        switch(id) {
        case PROGRESS_DIALOG:
            progressDialog.setProgress(0);
            progressThread = new ProgressThread(handler);
            progressThread.start();
        }
    }
        // Define the Handler that receives messages from the thread and update the progress
        final Handler handler = new Handler() {
            public void handleMessage(Message msg) {
            	Log.i("DEBUG","Now in handleMessage");
            	//we send -1 to the handler, when we parse the xml, then starting from 0 the importProgress
                int total = msg.arg1;
                if (total == -1) {
                	Toast.makeText(MyPreferenceActivity.this,"Loading categories from " + CATEGORIES_XML, Toast.LENGTH_LONG).show();
                } else {
	                progressDialog.setProgress(total);
	                if (total >= 100){
	                    dismissDialog(PROGRESS_DIALOG);
	                }
                }
            }
        };

        private class ProgressThread extends Thread {
            Handler mHandler;
           
            ProgressThread(Handler h) {
                mHandler = h;
            }
           
            public void run() {
            	Log.i("DEBUG","Now in run");
            	importCatsMain();
                importCatsSub();
	        	Message msg = mHandler.obtainMessage();
                msg.arg1 = totalCategories;
                mHandler.sendMessage(msg);
            }
            
            private int importCatsMain() {
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    Log.e("ERROR", "Thread Interrupted");
                }

            	Log.i("DEBUG","Now importCatsMain: " + categories.getLength());
            	//int result;
            	return 0;
            }
            private int importCatsSub() {
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    Log.e("ERROR", "Thread Interrupted");
                }
            	Log.i("DEBUG","Now importCatsSub: " + sub_categories.getLength());
            	//int result;
            	return 0;
            }

            
		    //returns 1 upon success, 0 upon failure
		    private int importCats() {
		    	//TODO check for uniqueness of parent_id + name
		    	//TODO correlate progress with number of cats
		        XmlPullParser parser = Xml.newPullParser();
		        ExpensesDbAdapter mDbHelper = new ExpensesDbAdapter(MyPreferenceActivity.this);
		        mDbHelper.open();
		        String tagName;
		        String label;
		        String id;
		        String parent_id;
		        long _id;
		        int result;
		        int total = 0;
		        
		        Hashtable<String,String> Foreign2LocalIdMap = new Hashtable<String,String>();
		        try {
		            // auto-detect the encoding from the stream
		            parser.setInput(new FileInputStream(CATEGORIES_XML), null);
		            int eventType = parser.getEventType();
		            while (eventType != XmlPullParser.END_DOCUMENT){
		                switch (eventType){
		                    case XmlPullParser.START_TAG:
		                        tagName = parser.getName();
		                       if (tagName == "Category") {
		                    	   label = parser.getAttributeValue(null, "Na");
		                    	   id = parser.getAttributeValue(null, "Nb");
		                    	   Log.w("MyPreferenceActivity", "Creating category with label " + 
		                    			   label + " and id " + id);
		                    	   _id = mDbHelper.createCategory(label,null);
		                    	   Foreign2LocalIdMap.put(id, String.valueOf(_id));
		                    	   
		                       } else if (tagName == "Sub_category") {
		                    	   label = parser.getAttributeValue(null, "Na");
		                    	   id = parser.getAttributeValue(null, "Nb");
		                    	   parent_id = parser.getAttributeValue(null, "Nbc");
		                    	   mDbHelper.createCategory(label, Foreign2LocalIdMap.get(parent_id));
		                        }
				                Log.i("DEBUG","Imported category " + total);
		                       	total++;
		                       	if (total % 10 == 0) {
			                       	Message msg = mHandler.obtainMessage();
	                                msg.arg1 = total / 2;
	                                mHandler.sendMessage(msg);
	                                Log.i("DEBUG","Sent message");
		                       	}
		                        break;
		                }
		                eventType = parser.next();
		            }
		            result = 1;
		        } catch (Exception e) {
		        	Log.e("MyExpenses",e.toString());
		        	result = 0;
		        }
		        mDbHelper.close();
		        return result;
		    }
        }
}
